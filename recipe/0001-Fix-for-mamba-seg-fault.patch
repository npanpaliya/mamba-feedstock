From 3892aefe3fc66b181db04c61cd39151e05f94244 Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23@in.ibm.com>
Date: Mon, 12 Jun 2023 11:59:12 +0000
Subject: [PATCH] Fix segmentation fault due to FIPS function

---
 libmamba/src/core/url.cpp | 14 +++++++-------
 1 file changed, 7 insertions(+), 7 deletions(-)

diff --git a/libmamba/src/core/url.cpp b/libmamba/src/core/url.cpp
index 45b38002..858cdd2e 100644
--- a/libmamba/src/core/url.cpp
+++ b/libmamba/src/core/url.cpp
@@ -168,16 +168,16 @@ namespace mamba
             u = u.substr(0, u.size() - 13);
         }
 
-        unsigned char hash[16];
-
-        EVP_MD_CTX* mdctx;
-        mdctx = EVP_MD_CTX_create();
-        EVP_DigestInit_ex(mdctx, EVP_md5(), nullptr);
+        unsigned char hash[EVP_MAX_MD_SIZE];
+        const EVP_MD* type = EVP_sha256();
+        unsigned int mdLen = 0;
+        EVP_MD_CTX *mdctx = EVP_MD_CTX_new();
+        EVP_DigestInit_ex(mdctx, type, nullptr);
         EVP_DigestUpdate(mdctx, u.c_str(), u.size());
-        EVP_DigestFinal_ex(mdctx, hash, nullptr);
+        EVP_DigestFinal_ex(mdctx, hash, &mdLen);
         EVP_MD_CTX_destroy(mdctx);
 
-        std::string hex_digest = hex_string(hash, 16);
+        std::string hex_digest = hex_string(hash, mdLen);
         return hex_digest.substr(0u, 8u);
     }
 
-- 
2.34.1

